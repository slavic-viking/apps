apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prometheus
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: production
  source:
    path: charts/prometheus
    repoURL: https://github.com/prometheus-community/helm-charts.git
    targetRevision: HEAD
    helm:
      values: |
        server:
          namespaces:
            - clusterwide
        extraScrapeConfigs: |
          - job_name: argo-workflows-metrics
            scrape_interval: 15s
            kubernetes_sd_configs:
            - role: pod
              namespaces:
                names:
                  - argo
          - job_name: argo-rollouts-metrics
            scrape_interval: 15s
            kubernetes_sd_configs:
            - role: pod
              namespaces:
                names:
                  - argo-rollouts
          - job_name: 'argo-events'
            kubernetes_sd_configs:
            - role: pod
              selectors:
              - role: pod
                label: 'controller in (eventsource-controller,sensor-controller,eventbus-controller)'
            relabel_configs:
            - source_labels: [__meta_kubernetes_pod_label_eventbus_name, __meta_kubernetes_pod_label_controller]
              action: replace
              regex: (.+);eventbus-controller
              replacement: $1
              target_label: 'eventbus_name'
            - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_pod_label_controller]
              action: replace
              regex: (.+);eventbus-controller
              replacement: $1
              target_label: 'namespace'
            - source_labels: [__address__, __meta_kubernetes_pod_label_controller]
              action: drop
              regex: (.+):(\d222);eventbus-controller
          - job_name: 'argo-events-controllers'
            kubernetes_sd_configs:
            - role: pod
              selectors:
              - role: pod
                label: 'app in (eventsource-controller,sensor-controller,eventbus-controller)'
            relabel_configs:
            - source_labels: [__address__, __meta_kubernetes_pod_label_app]
              action: replace
              regex: (.+);(eventsource-controller|sensor-controller|eventbus-controller)
              replacement: $1:7777
              target_label: '__address__'
            - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_pod_label_app]
              action: replace
              regex: (.+);(eventsource-controller|sensor-controller|eventbus-controller)
              replacement: $1
              target_label: 'namespace'
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
    syncOptions:
    - CreateNamespace=true
